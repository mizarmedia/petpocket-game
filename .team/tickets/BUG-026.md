# BUG-026: onRehydrateStorage callback not firing - app stuck loading

**Severity:** Critical
**Status:** Open
**Found by:** audit
**Assigned to:**
**Created:** 2025-12-25 17:08

## Description
CRITICAL: App permanently stuck on 'Loading...' screen

ROOT CAUSE IDENTIFIED:
- localStorage contains _hasHydrated: false (should never be persisted as false)
- onRehydrateStorage callback (gameStore.ts:670) not executing
- Callback should set: useGameStore.setState({ _hasHydrated: true })
- 100ms failsafe (App.tsx:32-41) also not working

SYMPTOMS:
- App shows 'Loading...' text forever
- Loading screen uses h-screen class (also broken = 3px height)
- Double bug: Both hydration AND h-screen broken

EVIDENCE:
- Browser localStorage: 'petplay-storage' exists (543 bytes)
- Parsed state shows: _hasHydrated: false
- App.tsx:131 checks: if (!_hasHydrated) return <Loading/>
- Loading screen never exits

FIX NEEDED:
1. Debug why onRehydrateStorage not firing
2. Check zustand persist middleware configuration
3. Verify failsafe useEffect is running
4. May need to NOT persist _hasHydrated field
5. Fix h-screen Tailwind class (separate issue)

FILES:
- src/stores/gameStore.ts:670 (callback)  
- src/App.tsx:32-41 (failsafe)
- src/App.tsx:131-139 (loading screen)

BLOCKING: Entire application, all users

## Steps to Reproduce
See description

## Expected Behavior
Feature should work correctly without this bug.

## Actual Behavior
CRITICAL: App permanently stuck on 'Loading...' screen

ROOT CAUSE IDENTIFIED:
- localStorage contains _hasHydrated: false (should never be persisted as false)
- onRehydrateStorage callback (gameStore.ts:670) not executing
- Callback should set: useGameStore.setState({ _hasHydrated: true })
- 100ms failsafe (App.tsx:32-41) also not working

SYMPTOMS:
- App shows 'Loading...' text forever
- Loading screen uses h-screen class (also broken = 3px height)
- Double bug: Both hydration AND h-screen broken

EVIDENCE:
- Browser localStorage: 'petplay-storage' exists (543 bytes)
- Parsed state shows: _hasHydrated: false
- App.tsx:131 checks: if (!_hasHydrated) return <Loading/>
- Loading screen never exits

FIX NEEDED:
1. Debug why onRehydrateStorage not firing
2. Check zustand persist middleware configuration
3. Verify failsafe useEffect is running
4. May need to NOT persist _hasHydrated field
5. Fix h-screen Tailwind class (separate issue)

FILES:
- src/stores/gameStore.ts:670 (callback)  
- src/App.tsx:32-41 (failsafe)
- src/App.tsx:131-139 (loading screen)

BLOCKING: Entire application, all users

## Environment
- **URL:** Production
- **Device:** See description

---

## Fix Notes
*Fixer fills this in when working*

**Root Cause:**
**Fix Applied:**
**Files Modified:**

---

## Verification
*Reviewer fills this in*

**Verified:**
**Tested On:**
**Notes:**
